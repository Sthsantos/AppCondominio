<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração de Condomínios</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging.js"></script>
    <script>
        // Configuração do Firebase (substitua pelos valores do seu projeto no Firebase Console)
        const firebaseConfig = {
            apiKey: "sua_api_key",
            authDomain: "seu_projeto.firebaseapp.com",
            projectId: "seu_projeto",
            storageBucket: "seu_projeto.appspot.com",
            messagingSenderId: "seu_sender_id",
            appId: "seu_app_id"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        // Função para registrar o token FCM
        function registerPush() {
            messaging.requestPermission().then(() => {
                return messaging.getToken();
            }).then((token) => {
                fetch('/register_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                }).then(response => console.log('Token registrado:', response));
            }).catch((err) => {
                console.error('Erro ao registrar push:', err);
            });
        }

        // Receber notificações em foreground
        messaging.onMessage((payload) => {
            console.log('Notificação recebida:', payload);
            alert(payload.notification.body); // Exemplo simples de exibição
        });

        // Registrar o Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js')
                .then((reg) => {
                    console.log('Service Worker registrado', reg);
                    registerPush(); // Registrar o token após o Service Worker estar pronto
                })
                .catch((err) => console.error('Erro ao registrar Service Worker', err));
        }

        // Função para abrir/fechar o menu lateral
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('open');
        }
    </script>
</head>
<body>
    <header>
        <div class="navbar">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo"></div>
        </div>
    </header>

    <!-- Menu Lateral -->
    <nav class="sidebar">
        <ul>
            <li><a href="{{ url_for('perfil') }}"><i class="fas fa-user"></i> Perfil</a></li>
            <li><a href="{{ url_for('configuracoes') }}"><i class="fas fa-cog"></i> Configurações</a></li>
            <li><a href="{{ url_for('manutencao') }}"><i class="fas fa-wrench"></i> Manutenção</a></li>
            <li><a href="{{ url_for('pagamentos') }}"><i class="fas fa-money-bill-wave"></i> Pagamentos</a></li>
            {% if session.get('tipo_usuario') == 'admin' %}
                <li><a href="{{ url_for('comunicacao') }}"><i class="fas fa-bullhorn"></i> Comunicação</a></li>
                <li><a href="{{ url_for('relatorios') }}"><i class="fas fa-chart-bar"></i> Relatórios</a></li>
                <li><a href="{{ url_for('estacionamento') }}"><i class="fas fa-car"></i> Estacionamento</a></li>
                <li><a href="{{ url_for('emergencias') }}"><i class="fas fa-exclamation-triangle"></i> Emergências</a></li>
                <li><a href="{{ url_for('cadastro_moradores') }}"><i class="fas fa-user-plus"></i> Cadastro de Moradores</a></li>
            {% endif %}
            <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
        </ul>
    </nav>

    <main>
        <section class="hero">
            {% if usuario %}
                <h1 class="animate-text">Bem-vindo, {{ usuario['nome'] }}!</h1>
            {% else %}
                <h1 class="animate-text">Bem-vindo ao Sistema de Administração</h1>
            {% endif %}
        </section>

        <!-- Seção para avisos e mensagens -->
        <section class="comunicados">
            <h2>Comunicados</h2>

            <!-- Avisos Gerais -->
            <div class="avisos">
                <h3>Avisos Gerais</h3>
                {% if avisos|length > 0 %}
                    <ul>
                        {% for aviso in avisos %}
                            <li>
                                <strong>{{ aviso['titulo'] }}</strong> - {{ aviso['data_envio'] }}<br>
                                <p>{{ aviso['mensagem'] }}</p>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Nenhum aviso geral no momento.</p>
                {% endif %}
            </div>

            <!-- Mensagens Específicas -->
            <div class="mensagens">
                <h3>Mensagens Pessoais</h3>
                {% if mensagens|length > 0 %}
                    <ul>
                        {% for mensagem in mensagens %}
                            <li>
                                <strong>{{ mensagem['titulo'] }}</strong> - {{ mensagem['data_envio'] }}<br>
                                <p>{{ mensagem['mensagem'] }}</p>
                                <form method="POST" action="{{ url_for('delete_mensagem', mensagem_id=mensagem['id']) }}" style="display: inline;">
                                    <button type="submit" class="btn-delete" onclick="return confirm('Tem certeza que deseja excluir esta mensagem?');">
                                        <i class="fas fa-trash"></i> Excluir
                                    </button>
                                </form>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Nenhuma mensagem pessoal no momento.</p>
                {% endif %}
            </div>
        </section>

        <section class="features">
            <!-- Apenas os itens solicitados na tela inicial -->
            <a href="{{ url_for('moradores') }}" class="feature-link">
                <div class="feature">
                    <i class="fas fa-users feature-icon"></i>
                    <h3>Moradores</h3>
                    {% if moradores|length > 0 %}
                        <p>{{ moradores|length }} moradores cadastrados</p>
                    {% else %}
                        <p>Nenhum morador cadastrado no momento</p>
                    {% endif %}
                </div>
            </a>
            <a href="{{ url_for('forum') }}" class="feature-link">
                <div class="feature">
                    <i class="fas fa-comment-dots feature-icon"></i>
                    <h3>Fórum</h3>
                    <p>Participe de discussões da comunidade.</p>
                </div>
            </a>
            <a href="{{ url_for('feedback') }}" class="feature-link">
                <div class="feature">
                    <i class="fas fa-comments feature-icon"></i>
                    <h3>Feedback</h3>
                    <p>Envie seus feedbacks e sugestões.</p>
                </div>
            </a>
            <a href="{{ url_for('correspondencias') }}" class="feature-link">
                <div class="feature">
                    <i class="fas fa-envelope feature-icon"></i>
                    <h3>Correspondências</h3>
                    <p>Acompanhe a entrega de suas correspondências.</p>
                </div>
            </a>
            <!-- Opções exclusivas para administradores mantidas na tela inicial apenas se necessário -->
            {% if session.get('tipo_usuario') == 'admin' %}
                <!-- Nenhum item admin adicional na tela inicial, todos já estão no menu lateral -->
            {% endif %}
        </section>
    </main>

    <!-- Barra Inferior -->
    <nav class="bottom-nav">
        <a href="{{ url_for('index') }}" class="{% if request.endpoint == 'index' %}active{% endif %}">
            <i class="fas fa-home"></i>
            <span>Início</span>
        </a>
        <a href="{{ url_for('anuncios') }}" class="{% if request.endpoint == 'anuncios' %}active{% endif %}">
            <i class="fas fa-bullhorn"></i>
            <span>Anúncios</span>
        </a>
        <a href="{{ url_for('reservas') }}" class="{% if request.endpoint == 'reservas' %}active{% endif %}">
            <i class="fas fa-calendar-alt"></i>
            <span>Reservas</span>
        </a>
        <a href="{{ url_for('comunicacao') }}" class="{% if request.endpoint == 'comunicacao' and session.get('tipo_usuario') == 'admin' %}active{% endif %}">
            <i class="fas fa-envelope"></i>
            <span>Mensagens</span>
        </a>
    </nav>
</body>
</html>
